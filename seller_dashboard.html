<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<title data-i18n="title">Seller Dashboard ‚Äì VanGuard Escrow</title>

<script src="https://cdn.jsdelivr.net/npm/i18next@23.7.6/i18next.min.js"></script>
<style>
   body{font-family:"Segoe UI",sans-serif;background:#f8fafc;margin:0;color:#0f172a;padding-bottom:60px;}
    header{background:linear-gradient(90deg,#1e40af,#3b82f6);color:white;padding:12px 16px;font-weight:700;display:flex;justify-content:space-between;align-items:center;}
    .header-left{display:flex;align-items:center;gap:12px}
    header button{background:white;color:#0f172a;border:none;border-radius:6px;padding:6px 12px;font-weight:600;cursor:pointer;}
    header select{padding:6px;border-radius:6px;border:none;font-weight:700}
    .container{max-width:1000px;margin:20px auto;padding:20px;}
    nav{display:flex;gap:12px;margin-bottom:20px;}
    nav button{flex:1;padding:12px;border:none;border-radius:8px;background:#e2e8f0;cursor:pointer;font-weight:600;}
    nav button.active{background:linear-gradient(90deg,#1e40af,#3b82f6);color:white;}
    .card{background:white;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
    h2{margin-top:0;}
    textarea,input{width:100%;padding:10px;margin-top:8px;border:1px solid #cbd5e1;border-radius:8px;font-size:14px;box-sizing:border-box;}
    button.action{margin-top:12px;padding:10px 16px;border:none;border-radius:8px;background:linear-gradient(90deg,#1e40af,#3b82f6);color:white;font-weight:600;cursor:pointer;}
    .wallet-box{font-family:monospace;padding:10px;background:#f1f5f9;border-radius:8px;margin-top:8px;display:flex;justify-content:space-between;align-items:center;}
    .msg{margin-top:10px;padding:8px 10px;border-radius:8px;font-size:13px;}
    .msg.success{background:rgba(16,185,129,0.08);color:#059669;}
    .msg.error{background:rgba(239,68,68,0.08);color:#dc2626;}
    table{width:100%;border-collapse:collapse;margin-top:10px;}
    th,td{padding:10px;border-bottom:1px solid #e2e8f0;text-align:left;vertical-align:middle;}
    .payment-list{display:flex;flex-direction:column;gap:10px;margin-top:8px}
    .payment-item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px;background:#fbfdff;border:1px solid rgba(2,6,23,0.03)}
    .method-label{font-weight:700}
    .method-note{font-size:13px;color:#6b7280}
    .small-note{font-size:13px;color:#6b7280;margin-top:8px}
    .copy-btn{padding:6px 10px;border-radius:8px;border:none;background:linear-gradient(90deg,#1e40af,#3b82f6);color:#fff;cursor:pointer;font-weight:600}
    .use-btn{padding:6px 10px;border-radius:8px;border:1px solid #cbd5e1;background:white;color:#0f172a;cursor:pointer}
    .selected-display{margin-top:8px;padding:8px;border-radius:8px;background:#f1f5f9;display:flex;justify-content:space-between;align-items:center;font-family:monospace}
    .file-list{margin-top:10px;padding:10px;background:#f8fafc;border-radius:8px;font-size:13px;}
    .file-item{padding:6px;background:white;border-radius:4px;margin-top:4px;display:flex;justify-content:space-between;align-items:center;}
    .wallet-input-group{margin-top:8px;display:flex;gap:8px;}
    .wallet-input-group input{flex:1;margin-top:0;}
    .save-btn{padding:6px 12px;border-radius:8px;border:none;background:#10b981;color:white;cursor:pointer;font-weight:600}
    footer{background:#f8fafc;border-top:2px solid #e2e8f0;padding:30px 20px;margin-top:40px;}
    .footer-content{max-width:1000px;margin:0 auto;}
    .footer-guide{background:white;border-radius:12px;padding:20px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
    .footer-guide h3{color:#1e40af;margin-top:0;}
    .footer-guide ol{padding-left:20px;}
    .footer-guide li{margin-bottom:10px;line-height:1.6;}
    .support-box{background:linear-gradient(90deg,#1e40af,#3b82f6);color:white;padding:20px;border-radius:12px;text-align:center;}
    .support-box h3{margin-top:0;}
    .support-link{display:inline-block;background:white;color:#1e40af;padding:12px 24px;border-radius:8px;text-decoration:none;font-weight:600;margin-top:10px;transition:transform 0.2s;}
    .support-link:hover{transform:translateY(-2px);}
</style>
</head>
<body>
<header>
<div class="header-left">
<span data-i18n="header.title" id="headerTitle">Seller Dashboard</span>
<a href="/index.html" style="margin-left:20px;color:white;text-decoration:none;font-weight:500;font-size:14px;padding:6px 12px;border:1px solid rgba(255,255,255,0.3);border-radius:6px;transition:all 0.2s" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='transparent'">üè† Home</a>
</div>
<div style="display:flex;align-items:center;gap:10px">
<select aria-label="Language selector" id="langSwitcher">
<option value="en">English</option>
<option value="de">Deutsch</option>
<option value="fr">Fran√ßais</option>
<option value="it">Italiano</option>
<option value="es">Espa√±ol</option>
</select>
<button data-i18n="btn.logout" id="logoutBtn">Logout</button>
</div>
</header>
<div class="container">
<nav aria-label="main-nav">
<button class="active" data-i18n="nav.escrow" id="tabEscrow">Escrow Setup</button>
<button data-i18n="nav.my_escrows" id="tabMyEscrows">My Escrows</button>
<button data-i18n="nav.transactions" id="tabTransactions">Transactions</button>
<button data-i18n="nav.kyc" id="tabKYC">KYC</button>
</nav>
<div id="escrowSection">
<div class="card">
<h2 data-i18n="pending.h2">Pending Escrows</h2>
<p data-i18n="pending.desc">Review buyer-initiated escrow requests awaiting your confirmation.</p>
<table>
<thead>
<tr>
<th data-i18n="tbl.id">ID</th>
<th data-i18n="tbl.buyer">Buyer</th>
<th data-i18n="tbl.amount">Amount</th>
<th data-i18n="tbl.actions">Actions</th>
</tr>
</thead>
<tbody id="pendingEscrowTable">
<tr>
<td colspan="4" style="text-align:center;color:#6b7280;">Loading pending escrows...</td>
</tr>
</tbody>
</table>
</div>

<div class="card">
<h2 data-i18n="delivery.h2">Submit Delivery & Terms</h2>
<form id="deliveryForm" method="POST">
<input id="escrowIdDelivery" name="escrowId" placeholder="Escrow ID" type="text" data-i18n-placeholder="ph.escrow_id"/>
<label for="deliveryTerms" style="display:block;margin-top:12px;font-weight:600;" data-i18n="label.delivery_terms">Delivery Terms:</label>
<textarea id="deliveryTerms" name="deliveryTerms" placeholder="Describe your deliverables or terms..." data-i18n-placeholder="ph.delivery_terms"></textarea>
<label for="deliverableContent" style="display:block;margin-top:12px;font-weight:600;" data-i18n="label.deliverable_content">Deliverable Content:</label>
<textarea id="deliverableContent" name="deliverableContent" placeholder="Paste deliverable text, download links, or instructions..." data-i18n-placeholder="ph.deliverable_content"></textarea>
<label for="attachFiles" style="display:block;margin-top:12px;font-weight:600;" data-i18n="label.attach_files">Attach Files:</label>
<input id="attachFiles" name="files" type="file" multiple style="margin-top:8px;"/>
<div class="file-list" id="filePreview" style="display:none;">
<strong data-i18n="label.selected_files">Selected Files:</strong>
<div id="fileListContent"></div>
</div>
<button class="action" id="submitDeliveryBtn" type="submit" data-i18n="btn.submit_delivery">Submit Delivery</button>
<div class="msg" id="deliveryMsg"></div>
</form>
</div>

<div class="card" id="withdrawalMethodsCard">
<h2 data-i18n="withdrawal.h2">Set Your Withdrawal Method</h2>
<p data-i18n="withdrawal.desc">Enter your wallet addresses where you want to receive payments. These will be used for all your payouts.</p>
<div class="payment-list" id="paymentList">
<div class="payment-item">
<div style="flex:1">
<div class="method-label" data-i18n="method.trc">USDT TRC20</div>
<div class="wallet-input-group">
<input type="text" id="wallet_trc" placeholder="Enter your USDT TRC20 wallet address" data-i18n-placeholder="ph.wallet_trc"/>
<button class="save-btn" data-i18n="btn.save" data-method="trc">Save</button>
</div>
</div>
</div>
<div class="payment-item">
<div style="flex:1">
<div class="method-label" data-i18n="method.erc">USDT ERC20</div>
<div class="wallet-input-group">
<input type="text" id="wallet_erc" placeholder="Enter your USDT ERC20 wallet address" data-i18n-placeholder="ph.wallet_erc"/>
<button class="save-btn" data-i18n="btn.save" data-method="erc">Save</button>
</div>
</div>
</div>
<div class="payment-item">
<div style="flex:1">
<div class="method-label" data-i18n="method.bep">BTC (BEP20)</div>
<div class="wallet-input-group">
<input type="text" id="wallet_bep" placeholder="Enter your BTC BEP20 wallet address" data-i18n-placeholder="ph.wallet_bep"/>
<button class="save-btn" data-i18n="btn.save" data-method="bep">Save</button>
</div>
</div>
</div>
<div class="payment-item">
<div style="flex:1">
<div class="method-label" data-i18n="method.cashapp">Cash App (US only)</div>
<div class="wallet-input-group">
<input type="text" id="wallet_cashapp" placeholder="Enter your Cash App username" data-i18n-placeholder="ph.wallet_cashapp"/>
<button class="save-btn" data-i18n="btn.save" data-method="cashapp">Save</button>
</div>
</div>
</div>
<div class="payment-item">
<div style="flex:1">
<div class="method-label" data-i18n="method.bank">Bank Transfer (Revolut Instant)</div>
<div class="method-note" data-i18n="method.bank_note">Contact support to set up bank transfer details</div>
</div>
</div>
</div>

<div class="selected-display" id="savedWalletsDisplay" style="display:none">
<strong data-i18n="label.saved_wallets">Saved Wallets:</strong>
<div id="savedWalletsList"></div>
</div>
</div>

<div class="card">
<h2 data-i18n="release.h2">Request Payment Release</h2>
<p data-i18n="release.desc">Request the buyer to release payment after completing the delivery. Make sure you've set your withdrawal method above.</p>
<form id="releaseRequestForm" method="POST">
<input id="escrowIdRelease" name="escrowId" placeholder="Escrow ID" type="text" data-i18n-placeholder="ph.escrow_id"/>
<button class="action" id="requestReleaseBtn" type="submit" data-i18n="btn.request_release">Request Release</button>
<div class="msg" id="releaseRequestMsg"></div>
</form>
</div>
</div>
<div id="myEscrowsSection" style="display:none;">
<div class="card">
<h2 data-i18n="my.h2">My Escrows</h2>
<table>
<thead>
<tr>
<th data-i18n="tbl.id">ID</th>
<th data-i18n="tbl.status">Status</th>
<th data-i18n="tbl.amount">Amount</th>
<th data-i18n="tbl.wallet">Wallet</th>
</tr>
</thead>
<tbody id="escrowTable">
<tr>
<td colspan="4" style="text-align:center;color:#6b7280;">Loading your escrows...</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="transactionsSection" style="display:none;">
<div class="card">
<h2 data-i18n="transactions.h2">Transactions</h2>
<ul id="transactionsList" style="padding-left:20px;">
<li style="color:#6b7280;">Loading transactions...</li>
</ul>
</div>
</div>
<div id="kycSection" style="display:none;">
<div class="card">
<h2 data-i18n="kyc.h2">KYC</h2>
<p data-i18n="kyc.note">KYC verification will be demanded for sellers who choose to receive payment via Bank Transfer.</p>
</div>
</div>
</div>

<footer>
<div class="footer-content">
<div class="footer-guide">
<h3 data-i18n="footer.guide_title">üìã How to Use the Seller Dashboard</h3>
<ol>
<li><strong data-i18n="footer.step1_title">Review Pending Escrows:</strong> <span data-i18n="footer.step1_desc">Check the "Pending Escrows" table to see buyer requests. Click "Confirm" to accept or "Reject" to decline.</span></li>
<li><strong data-i18n="footer.step2_title">Set Withdrawal Methods:</strong> <span data-i18n="footer.step2_desc">Enter your crypto wallet addresses or Cash App username. Click "Save" to store each payment method.</span></li>
<li><strong data-i18n="footer.step3_title">Submit Delivery:</strong> <span data-i18n="footer.step3_desc">After confirming an escrow, enter the Escrow ID, describe your deliverables, attach files if needed, and click "Submit Delivery".</span></li>
<li><strong data-i18n="footer.step4_title">Request Release:</strong> <span data-i18n="footer.step4_desc">Once delivery is complete, enter the Escrow ID and click "Request Release" to notify the buyer to release payment.</span></li>
<li><strong data-i18n="footer.step5_title">Track Your Escrows:</strong> <span data-i18n="footer.step5_desc">Use the "My Escrows" tab to monitor all your active transactions.</span></li>
</ol>
</div>
<div class="support-box">
<h3 data-i18n="footer.support_title">üí¨ Need Help?</h3>
<p data-i18n="footer.support_desc">Our support team is ready to assist you with any questions or issues.</p>
<a href="https://join.slack.com/share/enQtOTg3NTE1ODYzODcxMS0wODBmM2MyOGYxMTJiMTJhYWMzMmEwNWFlYmVjOGQ2NWNkMWFjY2ExNTY0ZjY5ZGE3YzcyZjA3NTRjNTc3Mjdi?p=free&entry_point=pricing_page" target="_blank" class="support-link" data-i18n="footer.support_link">Join Live Support on Slack</a>
</div>
</div>
</footer>

<script>
let currentUser = null;
let savedWallets = {};
const BASE_URL = "https://vanguardescrow-api-4.onrender.com";

// FIXED: Use /me endpoint instead of /checkSession
async function checkSession() {
  console.log("üîç ===== SESSION CHECK STARTED =====");
  
  // Check all possible token keys
  const tokenKeys = ['token', 'authToken', 'auth_token', 'sellerToken'];
  let token = null;
  let foundKey = null;
  
  for (const key of tokenKeys) {
    const value = localStorage.getItem(key);
    if (value) {
      token = value;
      foundKey = key;
      console.log(`‚úÖ Found token in localStorage with key: "${key}"`);
      break;
    }
  }
  
  if (!token) {
    console.error('‚ùå No auth token found in localStorage');
    console.log('üìã Available localStorage keys:', Object.keys(localStorage));
    console.log('üìã localStorage contents:', { ...localStorage });
    alert('No authentication token found. Please log in again.');
    return false;
  }

  console.log(`üîë Using token from key: "${foundKey}"`);
  console.log(`üîë Token preview: ${token.substring(0, 20)}...`);

  try {
    console.log("üì° Calling /me endpoint...");
    console.log(`üì° URL: ${BASE_URL}/me`);
    
    const res = await fetch(`${BASE_URL}/me`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });
    
    console.log("üì• Response status:", res.status);
    console.log("üì• Response headers:", [...res.headers.entries()]);
    
    if (!res.ok) {
      const errorText = await res.text();
      console.error('‚ùå Session validation failed');
      console.error('‚ùå Status:', res.status);
      console.error('‚ùå Response:', errorText);
      
      // Clear invalid token
      localStorage.removeItem(foundKey);
      
      alert(`Session validation failed (${res.status}). Please log in again.`);
      return false;
    }
    
    const data = await res.json();
    console.log("üì¶ Session data received:", JSON.stringify(data, null, 2));
    
    currentUser = data;
    
    // Check if user object has the role property
    if (!currentUser.role) {
      console.error('‚ùå User object missing "role" property');
      console.error('üì¶ User object structure:', Object.keys(currentUser));
      alert('Invalid user data received. Please contact support.');
      return false;
    }
    
    console.log("üë§ User role:", currentUser.role);
    console.log("üìß User email:", currentUser.email || 'Not provided');
    
    if (currentUser.role !== 'seller') {
      console.warn(`‚ùå Access denied. User role is: "${currentUser.role}", expected: "seller"`);
      alert(`This dashboard is for sellers only. Your role: ${currentUser.role}`);
      return false;
    }
    
    console.log('‚úÖ ===== SESSION CHECK PASSED =====');
    console.log(`‚úÖ Logged in as seller: ${currentUser.email}`);
    
    // If token was found with a different key, migrate it to 'token'
    if (foundKey !== 'token') {
      console.log(`üîÑ Migrating token from "${foundKey}" to "token"`);
      localStorage.setItem('token', token);
      localStorage.removeItem(foundKey);
    }
    
    return true;
  } catch (error) {
    console.error('‚ùå ===== SESSION CHECK FAILED =====');
    console.error('‚ùå Error type:', error.name);
    console.error('‚ùå Error message:', error.message);
    console.error('‚ùå Error stack:', error.stack);
    
    alert(`Session check failed: ${error.message}. Please try logging in again.`);
    return false;
  }
}

// FIXED: Use consistent token 'token' everywhere
async function loadPendingEscrows() {
  const token = localStorage.getItem('token');
  if (!token) {
    console.error('No auth token found');
    return;
  }

  try {
    const res = await fetch(`${BASE_URL}/sellerPendingEscrows`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!res.ok) {
      throw new Error('Failed to fetch pending escrows');
    }

const data = await res.json();
const pendingEscrows = data.escrows || data || [];
const tableBody = document.getElementById('pendingEscrowTable');

if (pendingEscrows.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280;">No pending escrows found</td></tr>';
      return;
    }

    tableBody.innerHTML = '';
    pendingEscrows.forEach(escrow => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${escrow.id}</td>
       <td>Buyer ID: ${escrow.buyer_id || 'N/A'}</td>
        <td>${escrow.amount} ${escrow.currency}</td>
        <td>
          <button onclick="confirmEscrow('${escrow.id}')" style="padding:6px 12px;background:#10b981;color:white;border:none;border-radius:4px;margin-right:8px;cursor:pointer;">Confirm</button>
          <button onclick="rejectEscrow('${escrow.id}')" style="padding:6px 12px;background:#ef4444;color:white;border:none;border-radius:4px;cursor:pointer;">Reject</button>
          <div class="msg" id="pendingMsg_${escrow.id}"></div>
        </td>
      `;
      tableBody.appendChild(row);
    });

  } catch (error) {
    console.error('Error loading pending escrows:', error);
    const tableBody = document.getElementById('pendingEscrowTable');
    tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#dc2626;">Error loading pending escrows</td></tr>';
  }
}

// NEW: Load My Escrows
async function loadMyEscrows() {
  const token = localStorage.getItem('token');
  if (!token) return;

  try {
    const res = await fetch(`${BASE_URL}/sellerEscrows`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      }
    });

    if (!res.ok) throw new Error('Failed to fetch escrows');

    const escrows = await res.json();
    const tableBody = document.getElementById('escrowTable');
    
    if (escrows.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:#6b7280;">No escrows found</td></tr>';
      return;
    }

    tableBody.innerHTML = '';
    escrows.forEach(escrow => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${escrow.id}</td>
        <td>${escrow.status}</td>
        <td>${escrow.amount} ${escrow.currency}</td>
        <td style="font-family:monospace;font-size:12px;">${escrow.wallet || 'N/A'}</td>
      `;
      tableBody.appendChild(row);
    });

  } catch (error) {
    console.error('Error loading escrows:', error);
    document.getElementById('escrowTable').innerHTML = '<tr><td colspan="4" style="text-align:center;color:#dc2626;">Error loading escrows</td></tr>';
  }
}

function loadSavedWallets() {
  const saved = localStorage.getItem('sellerWallets');
  if (saved) {
    savedWallets = JSON.parse(saved);
    updateSavedWalletsDisplay();
  }
}

function saveWallet(method, address) {
  if (!address.trim()) {
    alert('Please enter a wallet address');
    return false;
  }
  
  savedWallets[method] = address.trim();
  localStorage.setItem('sellerWallets', JSON.stringify(savedWallets));
  updateSavedWalletsDisplay();
  
  const methodNames = {
    'trc': 'USDT TRC20',
    'erc': 'USDT ERC20', 
    'bep': 'BTC BEP20',
    'cashapp': 'Cash App'
  };
  
  alert(`${methodNames[method]} wallet saved successfully!`);
  return true;
}

function updateSavedWalletsDisplay() {
  const display = document.getElementById('savedWalletsDisplay');
  const list = document.getElementById('savedWalletsList');
  
  if (Object.keys(savedWallets).length === 0) {
    display.style.display = 'none';
    return;
  }
  
  display.style.display = 'block';
  list.innerHTML = '';
  
  const methodNames = {
    'trc': 'USDT TRC20',
    'erc': 'USDT ERC20',
    'bep': 'BTC BEP20',
    'cashapp': 'Cash App'
  };
  
  Object.keys(savedWallets).forEach(method => {
    const walletItem = document.createElement('div');
    walletItem.style.marginTop = '4px';
    walletItem.style.padding = '4px';
    walletItem.style.background = '#f1f5f9';
    walletItem.style.borderRadius = '4px';
    walletItem.innerHTML = `<strong>${methodNames[method]}:</strong> <span style="font-family: monospace;">${savedWallets[method]}</span>`;
    list.appendChild(walletItem);
  });
}

// FIXED: Consolidated initialization
window.addEventListener("DOMContentLoaded", async () => {
  console.log('üöÄ ===== SELLER DASHBOARD INITIALIZING =====');
  console.log('üåê BASE_URL:', BASE_URL);
  console.log('üìÖ Current time:', new Date().toISOString());
  
  try {
    const sessionValid = await checkSession();
    
    if (!sessionValid) {
      console.error('‚ùå Session validation failed, redirecting to homepage...');
      setTimeout(() => {
        window.location.href = '/index.html';
      }, 2000); // Give user time to see the error
      return;
    }
    
    console.log('‚úÖ Session valid, loading dashboard...');
    
    loadSavedWallets();
    loadPendingEscrows();
  } catch (error) {
    console.error('‚ùå Fatal error during initialization:', error);
    alert(`Failed to initialize dashboard: ${error.message}`);
    setTimeout(() => {
      window.location.href = '/index.html';
    }, 2000);
    return;
  }

  // FIXED: Use consistent token 'token' everywhere
  async function handleEscrowAction(escrowId, endpoint, msgId, actionName) {
    const token = localStorage.getItem('token');
    if (!token) {
      console.error('No auth token found');
      return;
    }

    const msg = document.getElementById(msgId);
    if (msg) {
      msg.innerHTML = "Processing...";
      msg.className = "msg";
    }

    try {
      const res = await fetch(`${BASE_URL}${endpoint}`, { 
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ escrowId })
      });

      if (res.status === 401) {
        console.error('401 Unauthorized - token invalid');
        localStorage.removeItem('token');
        if (msg) {
          msg.innerHTML = `Session expired. Please log in again.`;
          msg.className = "msg error";
        }
        return; 
      }
      
      let text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch { json = null; }

      if (!res.ok) throw new Error(json?.error || ("HTTP " + res.status));

      if (msg) {
        msg.innerHTML = "‚úÖ " + actionName + " successful!";
        if (json && json.escrowId) {
          msg.innerHTML += "<br>Escrow ID: " + json.escrowId;
        }
        msg.className = "msg success";
      }
      console.log(actionName + " success:", json);
// Reload pending escrows after action
      setTimeout(() => loadPendingEscrows(), 1000);
      
    } catch (err) {
      if (msg) {
        msg.innerHTML = "‚ùå " + (err.message || "Network/System Error");
        msg.className = "msg error";
      }
      console.error(actionName + " error:", err);
    }
  }

  // FIXED: Use consistent token 'token'
// FIXED: Handle delivery submission with proper field extraction
  async function handleDeliverySubmit(e) {
    e.preventDefault();
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Session expired. Please log in again.');
      return;
    }

    const msg = document.getElementById('deliveryMsg');
    
    // Get values directly from inputs
    const escrowId = document.getElementById('escrowIdDelivery').value.trim();
    const deliveryTerms = document.getElementById('deliveryTerms').value.trim();
    const deliverableContent = document.getElementById('deliverableContent').value.trim();
    const filesInput = document.getElementById('attachFiles');
    
    // Validate escrowId
    if (!escrowId) {
      msg.innerHTML = "‚ùå Please enter an Escrow ID";
      msg.className = "msg error";
      return;
    }

    msg.innerHTML = "Processing...";
    msg.className = "msg";

    try {
      const formData = new FormData();
      formData.append('escrowId', escrowId);
      formData.append('deliveryTerms', deliveryTerms);
      formData.append('deliverableContent', deliverableContent);
      
      // Add files if any
      if (filesInput.files.length > 0) {
        for (let i = 0; i < filesInput.files.length; i++) {
          formData.append('files', filesInput.files[i]);
        }
      }
      
      // Debug log
      console.log('üì§ Sending delivery for escrow:', escrowId);
      
      const res = await fetch(BASE_URL + "/sellerSubmitDelivery", { 
        method: "POST",
        headers: {
          'Authorization': `Bearer ${token}`
        },
        body: formData
      });

      if (res.status === 401) {
        console.error('401 Unauthorized - token invalid');
        localStorage.removeItem('token');
        msg.innerHTML = `Session expired. Please log in again.`;
        msg.className = "msg error";
        return; 
      }
      
      let text = await res.text();
      console.log('üì• Response:', text);
      let json;
      try { json = JSON.parse(text); } catch { json = null; }

      if (!res.ok) throw new Error(json?.error || ("HTTP " + res.status));

      msg.innerHTML = "‚úÖ Delivery submitted successfully!";
      msg.className = "msg success";
      console.log("Delivery submit success:", json);
      
      // Clear form
      document.getElementById('escrowIdDelivery').value = '';
      document.getElementById('deliveryTerms').value = '';
      document.getElementById('deliverableContent').value = '';
      document.getElementById('attachFiles').value = '';
      document.getElementById('filePreview').style.display = 'none';
      
    } catch (err) {
      msg.innerHTML = "‚ùå " + (err.message || "Network/System Error");
      msg.className = "msg error";
      console.error("Delivery submit error:", err);
    }
  }

  // FIXED: Use consistent token 'token'
  async function handleReleaseRequest(e) {
    e.preventDefault();
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Session expired. Please log in again.');
      return;
    }

    if (Object.keys(savedWallets).length === 0) {
      alert('Please set up at least one withdrawal method before requesting release.');
      return;
    }

    const form = e.target;
    const msg = document.getElementById('releaseRequestMsg');
    msg.innerHTML = "Processing...";
    msg.className = "msg";
    const data = Object.fromEntries(new FormData(form).entries());

    try {
      const res = await fetch(BASE_URL + "/sellerRequestRelease", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(data)
      });

      if (res.status === 401) {
        console.error('401 Unauthorized - token invalid');
        localStorage.removeItem('token');
        msg.innerHTML = `Session expired. Please log in again.`;
        msg.className = "msg error";
        return; 
      }
      
      let text = await res.text();
      let json;
      try { json = JSON.parse(text); } catch { json = null; }

      if (!res.ok) throw new Error(json?.error || ("HTTP " + res.status));

      msg.innerHTML = "‚úÖ Release request sent successfully!";
      msg.className = "msg success";
      console.log("Release request success:", json);
      
    } catch (err) {
      msg.innerHTML = "‚ùå " + (err.message || "Network/System Error");
      msg.className = "msg error";
      console.error("Release request error:", err);
    }
  }

  // Event listeners
  document.getElementById("deliveryForm")?.addEventListener("submit", handleDeliverySubmit);
  document.getElementById("releaseRequestForm")?.addEventListener("submit", handleReleaseRequest);
  console.log('‚úÖ Event listeners registered. handleDeliverySubmit exists:', typeof handleDeliverySubmit);

  // Wallet save buttons
  document.querySelectorAll('.save-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const method = this.getAttribute('data-method');
      const input = document.getElementById(`wallet_${method}`);
      saveWallet(method, input.value);
    });
  });

  // File preview
  document.getElementById("attachFiles")?.addEventListener("change", function(e) {
    const files = e.target.files;
    const preview = document.getElementById('filePreview');
    const listContent = document.getElementById('fileListContent');
    
    if (files.length > 0) {
      preview.style.display = 'block';
      listContent.innerHTML = '';
      for (let i = 0; i < files.length; i++) {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.innerHTML = `<span>${files[i].name}</span><span style="color:#6b7280;">${(files[i].size / 1024).toFixed(1)} KB</span>`;
        listContent.appendChild(fileItem);
      }
    } else {
      preview.style.display = 'none';
    }
  });

  // Global functions for escrow actions
  window.confirmEscrow = function(escrowId) {
    handleEscrowAction(escrowId, "/sellerConfirm", "pendingMsg_" + escrowId, "Confirm Escrow");
  };

  window.rejectEscrow = function(escrowId) {
    handleEscrowAction(escrowId, "/sellerReject", "pendingMsg_" + escrowId, "Reject Escrow");
  };

  // FIXED: Logout function
  document.getElementById("logoutBtn")?.addEventListener("click", async () => {
    try {
      localStorage.removeItem('token');
      localStorage.removeItem('sellerWallets');
      console.log('Logged out successfully');
      window.location.href = '/index.html';
    } catch (error) {
      console.error('Logout error:', error);
      window.location.href = '/index.html';
    }
  });

  // FIXED: Tab system - integrated into main initialization
  const tabs = {
    tabEscrow: "escrowSection",
    tabMyEscrows: "myEscrowsSection",
    tabTransactions: "transactionsSection",
    tabKYC: "kycSection"
  };

  const buttons = Object.keys(tabs).map(id => document.getElementById(id)).filter(btn => btn);
  const sections = Object.values(tabs).map(id => document.getElementById(id)).filter(sec => sec);

  function showSection(showId) {
    sections.forEach(sec => {
      sec.style.display = (sec.id === showId) ? "block" : "none";
    });

    buttons.forEach(btn => {
      const target = tabs[btn.id];
      if (target === showId) {
        btn.classList.add("active");
      } else {
        btn.classList.remove("active");
      }
    });

    // Load data when switching to specific tabs
    if (showId === "myEscrowsSection") {
      loadMyEscrows();
    }
  }

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      const targetId = tabs[btn.id];
      if (targetId) {
        showSection(targetId);
      }
    });
  });

  // Show default section
  showSection("escrowSection");
});

// FIXED: Translation system - properly initialized
const translations = {
  en: {
    translation: {
      "title": "Seller Dashboard ‚Äì VanGuard Escrow",
      "header.title": "Seller Dashboard",
      "btn.logout": "Logout",
      "nav.escrow": "Escrow Setup",
      "nav.my_escrows": "My Escrows",
      "nav.transactions": "Transactions",
      "nav.kyc": "KYC",
      "pending.h2": "Pending Escrows",
      "pending.desc": "Review buyer-initiated escrow requests awaiting your confirmation.",
      "delivery.h2": "Submit Delivery & Terms",
      "release.h2": "Request Payment Release",
      "release.desc": "Request the buyer to release payment after completing the delivery. Make sure you've set your withdrawal method above.",
      "withdrawal.h2": "Set Your Withdrawal Method",
      "withdrawal.desc": "Enter your wallet addresses where you want to receive payments. These will be used for all your payouts.",
      "method.trc": "USDT TRC20",
      "method.erc": "USDT ERC20",
      "method.bep": "BTC (BEP20)",
      "method.cashapp": "Cash App (US only)",
      "method.bank": "Bank Transfer (Revolut Instant)",
      "method.bank_note": "Contact support to set up bank transfer details",
      "btn.copy": "Copy",
      "btn.save": "Save",
      "btn.info": "Info",
      "btn.submit_delivery": "Submit Delivery",
      "btn.request_release": "Request Release",
      "btn.confirm_escrow": "Confirm Escrow",
      "btn.reject_escrow": "Reject Escrow",
      "ph.escrow_id": "Escrow ID",
      "ph.delivery_terms": "Describe your deliverables or terms...",
      "ph.deliverable_content": "Paste deliverable text, download links, or instructions...",
      "ph.wallet_trc": "Enter your USDT TRC20 wallet address",
      "ph.wallet_erc": "Enter your USDT ERC20 wallet address", 
      "ph.wallet_bep": "Enter your BTC BEP20 wallet address",
      "ph.wallet_cashapp": "Enter your Cash App username",
      "label.delivery_terms": "Delivery Terms:",
      "label.deliverable_content": "Deliverable Content:",
      "label.attach_files": "Attach Files:",
      "label.selected_files": "Selected Files:",
      "label.saved_wallets": "Saved Wallets:",
      "note.bank_limit": "NB: Bank transfers aren't supported for transfers above $5000. For bank transfer assistance use Google Meet or support@vanguardescrow.online.",
      "my.h2": "My Escrows",
      "tbl.id": "ID",
      "tbl.buyer": "Buyer",
      "tbl.status": "Status",
      "tbl.amount": "Amount",
      "tbl.wallet": "Wallet",
      "tbl.actions": "Actions",
      "transactions.h2": "Transactions",
      "kyc.h2": "KYC",
      "kyc.note": "KYC verification will be demanded for sellers who choose to receive payment via Bank Transfer.",
      "footer.guide_title": "üìã How to Use the Seller Dashboard",
      "footer.step1_title": "Review Pending Escrows:",
      "footer.step1_desc": "Check the \"Pending Escrows\" table to see buyer requests. Click \"Confirm\" to accept or \"Reject\" to decline.",
      "footer.step2_title": "Set Withdrawal Methods:",
      "footer.step2_desc": "Enter your crypto wallet addresses or Cash App username. Click \"Save\" to store each payment method.",
      "footer.step3_title": "Submit Delivery:",
      "footer.step3_desc": "After confirming an escrow, enter the Escrow ID, describe your deliverables, attach files if needed, and click \"Submit Delivery\".",
      "footer.step4_title": "Request Release:",
      "footer.step4_desc": "Once delivery is complete, enter the Escrow ID and click \"Request Release\" to notify the buyer to release payment.",
      "footer.step5_title": "Track Your Escrows:",
      "footer.step5_desc": "Use the \"My Escrows\" tab to monitor all your active transactions.",
      "footer.support_title": "üí¨ Need Help?",
      "footer.support_desc": "Our support team is ready to assist you with any questions or issues.",
      "footer.support_link": "Join Live Support on Slack"
    }
  },
  de: {
    translation: {
      "title": "Verk√§ufer-Dashboard ‚Äì VanGuard Escrow",
      "header.title": "Verk√§ufer-Dashboard",
      "btn.logout": "Abmelden",
      "nav.escrow": "Escrow-Einrichtung",
      "nav.my_escrows": "Meine Escrows",
      "nav.transactions": "Transaktionen",
      "nav.kyc": "KYC",
      "pending.h2": "Ausstehende Escrows",
      "pending.desc": "√úberpr√ºfen Sie vom K√§ufer initiierte Escrow-Anfragen, die auf Ihre Best√§tigung warten.",
      "delivery.h2": "Lieferung & Bedingungen einreichen",
      "release.h2": "Zahlungsfreigabe anfordern",
      "release.desc": "Fordern Sie den K√§ufer auf, die Zahlung nach Abschluss der Lieferung freizugeben. Stellen Sie sicher, dass Sie Ihre Auszahlungsmethode oben festgelegt haben.",
      "withdrawal.h2": "Auszahlungsmethode festlegen",
      "withdrawal.desc": "Geben Sie Ihre Wallet-Adressen ein, an die Sie Zahlungen erhalten m√∂chten. Diese werden f√ºr alle Ihre Auszahlungen verwendet.",
      "method.trc": "USDT TRC20",
      "method.erc": "USDT ERC20",
      "method.bep": "BTC (BEP20)",
      "method.cashapp": "Cash App (solo EE. UU.)",
      "method.bank": "Transferencia bancaria (Revolut Instant)",
      "method.bank_note": "Kontaktieren Sie den Support, um Bank√ºberweisungsdetails einzurichten",
      "btn.copy": "Kopieren",
      "btn.save": "Speichern",
      "btn.info": "Info",
      "btn.submit_delivery": "Lieferung einreichen",
      "btn.request_release": "Freigabe anfordern",
      "btn.confirm_escrow": "Escrow best√§tigen",
      "btn.reject_escrow": "Escrow ablehnen",
      "ph.escrow_id": "Escrow-ID",
      "ph.delivery_terms": "Beschreiben Sie Ihre Liefergegenst√§nde oder Bedingungen...",
      "ph.deliverable_content": "F√ºgen Sie Liefertext, Download-Links oder Anweisungen ein...",
      "ph.wallet_trc": "Geben Sie Ihre USDT TRC20 Wallet-Adresse ein",
      "ph.wallet_erc": "Geben Sie Ihre USDT ERC20 Wallet-Adresse ein",
      "ph.wallet_bep": "Geben Sie Ihre BTC BEP20 Wallet-Adresse ein", 
      "ph.wallet_cashapp": "Geben Sie Ihren Cash App Benutzernamen ein",
      "label.delivery_terms": "Lieferbedingungen:",
      "label.deliverable_content": "Lieferinhalt:",
      "label.attach_files": "Dateien anh√§ngen:",
      "label.selected_files": "Ausgew√§hlte Dateien:",
      "label.saved_wallets": "Gespeicherte Wallets:",
      "note.bank_limit": "Hinweis: Bank√ºberweisungen werden nicht f√ºr Betr√§ge √ºber 5000 $ unterst√ºtzt.",
      "my.h2": "Meine Escrows",
      "tbl.id": "ID",
      "tbl.buyer": "K√§ufer",
      "tbl.status": "Status",
      "tbl.amount": "Betrag",
      "tbl.wallet": "Wallet",
      "tbl.actions": "Aktionen",
      "transactions.h2": "Transaktionen",
      "kyc.h2": "KYC",
      "kyc.note": "KYC-Verifizierung wird f√ºr Verk√§ufer verlangt, die per Bank√ºberweisung bezahlt werden m√∂chten.",
      "footer.guide_title": "üìã So verwenden Sie das Verk√§ufer-Dashboard",
      "footer.step1_title": "Ausstehende Escrows √ºberpr√ºfen:",
      "footer.step1_desc": "√úberpr√ºfen Sie die Tabelle \"Ausstehende Escrows\", um K√§uferanfragen zu sehen. Klicken Sie auf \"Best√§tigen\" zum Akzeptieren oder \"Ablehnen\" zum Ablehnen.",
      "footer.step2_title": "Auszahlungsmethoden festlegen:",
      "footer.step2_desc": "Geben Sie Ihre Krypto-Wallet-Adressen oder Ihren Cash App-Benutzernamen ein. Klicken Sie auf \"Speichern\", um jede Zahlungsmethode zu speichern.",
      "footer.step3_title": "Lieferung einreichen:",
      "footer.step3_desc": "Nach Best√§tigung eines Escrows geben Sie die Escrow-ID ein, beschreiben Sie Ihre Liefergegenst√§nde, h√§ngen Sie bei Bedarf Dateien an und klicken Sie auf \"Lieferung einreichen\".",
      "footer.step4_title": "Freigabe anfordern:",
      "footer.step4_desc": "Sobald die Lieferung abgeschlossen ist, geben Sie die Escrow-ID ein und klicken Sie auf \"Freigabe anfordern\", um den K√§ufer √ºber die Zahlungsfreigabe zu benachrichtigen.",
      "footer.step5_title": "Ihre Escrows verfolgen:",
      "footer.step5_desc": "Verwenden Sie die Registerkarte \"Meine Escrows\", um alle Ihre aktiven Transaktionen zu √ºberwachen.",
      "footer.support_title": "üí¨ Brauchen Sie Hilfe?",
      "footer.support_desc": "Unser Support-Team ist bereit, Sie bei Fragen oder Problemen zu unterst√ºtzen.",
      "footer.support_link": "Live-Support auf Slack beitreten"
    }
  },
  fr: {
    translation: {
      "title": "Tableau de bord vendeur ‚Äì VanGuard Escrow",
      "header.title": "Tableau de bord vendeur",
      "btn.logout": "D√©connexion",
      "nav.escrow": "Configuration Escrow",
      "nav.my_escrows": "Mes Escrows",
      "nav.transactions": "Transactions",
      "nav.kyc": "KYC",
      "pending.h2": "Escrows en attente",
      "pending.desc": "Examinez les demandes d'escrow initi√©es par l'acheteur en attente de votre confirmation.",
      "delivery.h2": "Soumettre la livraison et les conditions",
      "release.h2": "Demander la lib√©ration du paiement",
      "release.desc": "Demandez √† l'acheteur de lib√©rer le paiement apr√®s avoir termin√© la livraison. Assurez-vous d'avoir configur√© votre m√©thode de retrait ci-dessus.",
      "withdrawal.h2": "Configurer votre m√©thode de retrait",
      "withdrawal.desc": "Entrez vos adresses de portefeuille o√π vous souhaitez recevoir les paiements. Elles seront utilis√©es pour tous vos versements.",
      "method.trc": "USDT TRC20",
      "method.erc": "USDT ERC20",
      "method.bep": "BTC (BEP20)",
      "method.cashapp": "Cash App (USA uniquement)",
      "method.bank": "Virement bancaire (Revolut Instant)",
      "method.bank_note": "Contactez le support pour configurer les d√©tails de virement bancaire",
      "btn.copy": "Copier",
      "btn.save": "Sauvegarder",
      "btn.info": "Info",
      "btn.submit_delivery": "Soumettre la livraison",
      "btn.request_release": "Demander la lib√©ration",
      "btn.confirm_escrow": "Confirmer l'escrow",
      "btn.reject_escrow": "Rejeter l'escrow",
      "ph.escrow_id": "ID Escrow",
      "ph.delivery_terms": "D√©crivez vos livrables ou conditions...",
      "ph.deliverable_content": "Collez le texte livrable, les liens de t√©l√©chargement ou les instructions...",
      "ph.wallet_trc": "Entrez votre adresse de portefeuille USDT TRC20",
      "ph.wallet_erc": "Entrez votre adresse de portefeuille USDT ERC20",
      "ph.wallet_bep": "Entrez votre adresse de portefeuille BTC BEP20",
      "ph.wallet_cashapp": "Entrez votre nom d'utilisateur Cash App",
      "label.delivery_terms": "Conditions de livraison:",
      "label.deliverable_content": "Contenu livrable:",
      "label.attach_files": "Joindre des fichiers:",
      "label.selected_files": "Fichiers s√©lectionn√©s:",
      "label.saved_wallets": "Portefeuilles sauvegard√©s:",
      "note.bank_limit": "NB: Les virements bancaires ne sont pas pris en charge pour les montants sup√©rieurs √† 5000 $.",
      "my.h2": "Mes Escrows",
      "tbl.id": "ID",
      "tbl.buyer": "Acheteur",
      "tbl.status": "Statut",
      "tbl.amount": "Montant",
      "tbl.wallet": "Portefeuille",
      "tbl.actions": "Actions",
      "transactions.h2": "Transactions",
      "kyc.h2": "KYC",
      "kyc.note": "La v√©rification KYC sera demand√©e aux vendeurs qui choisissent de recevoir le paiement par virement bancaire.",
      "footer.guide_title": "üìã Comment utiliser le tableau de bord vendeur",
      "footer.step1_title": "Examiner les escrows en attente:",
      "footer.step1_desc": "Consultez le tableau \"Escrows en attente\" pour voir les demandes d'acheteurs. Cliquez sur \"Confirmer\" pour accepter ou \"Rejeter\" pour refuser.",
      "footer.step2_title": "D√©finir les m√©thodes de retrait:",
      "footer.step2_desc": "Entrez vos adresses de portefeuille crypto ou votre nom d'utilisateur Cash App. Cliquez sur \"Sauvegarder\" pour enregistrer chaque m√©thode de paiement.",
      "footer.step3_title": "Soumettre la livraison:",
      "footer.step3_desc": "Apr√®s avoir confirm√© un escrow, entrez l'ID Escrow, d√©crivez vos livrables, joignez des fichiers si n√©cessaire et cliquez sur \"Soumettre la livraison\".",
      "footer.step4_title": "Demander la lib√©ration:",
      "footer.step4_desc": "Une fois la livraison termin√©e, entrez l'ID Escrow et cliquez sur \"Demander la lib√©ration\" pour notifier l'acheteur de lib√©rer le paiement.",
      "footer.step5_title": "Suivre vos escrows:",
      "footer.step5_desc": "Utilisez l'onglet \"Mes Escrows\" pour surveiller toutes vos transactions actives.",
      "footer.support_title": "üí¨ Besoin d'aide?",
      "footer.support_desc": "Notre √©quipe de support est pr√™te √† vous aider pour toute question ou probl√®me.",
      "footer.support_link": "Rejoindre le support en direct sur Slack"
    }
  },
  it: {
    translation: {
      "title": "Dashboard Venditore ‚Äì VanGuard Escrow",
      "header.title": "Dashboard Venditore",
      "btn.logout": "Disconnetti",
      "nav.escrow": "Configurazione Escrow",
      "nav.my_escrows": "I Miei Escrow",
      "nav.transactions": "Transazioni",
      "nav.kyc": "KYC",
      "pending.h2": "Escrow in sospeso",
      "pending.desc": "Rivedi le richieste di escrow avviate dall'acquirente in attesa della tua conferma.",
      "delivery.h2": "Invia consegna e termini",
      "release.h2": "Richiedi rilascio pagamento",
      "release.desc": "Richiedi all'acquirente di rilasciare il pagamento dopo aver completato la consegna. Assicurati di aver impostato il tuo metodo di prelievo sopra.",
      "withdrawal.h2": "Imposta il tuo metodo di prelievo",
      "withdrawal.desc": "Inserisci i tuoi indirizzi wallet dove desideri ricevere i pagamenti. Questi verranno utilizzati per tutti i tuoi pagamenti.",
      "method.trc": "USDT TRC20",
      "method.erc": "USDT ERC20",
      "method.bep": "BTC (BEP20)",
      "method.cashapp": "Cash App (solo USA)",
      "method.bank": "Bonifico bancario (Revolut Instant)",
      "method.bank_note": "Contatta il supporto per impostare i dettagli del bonifico bancario",
      "btn.copy": "Copia",
      "btn.save": "Salva",
      "btn.info": "Info",
      "btn.submit_delivery": "Invia consegna",
      "btn.request_release": "Richiedi rilascio",
      "btn.confirm_escrow": "Conferma escrow",
      "btn.reject_escrow": "Rifiuta escrow",
      "ph.escrow_id": "ID Escrow",
      "ph.delivery_terms": "Descrivi i tuoi consegnabili o termini...",
      "ph.deliverable_content": "Incolla testo consegnabile, link di download o istruzioni...",
      "ph.wallet_trc": "Inserisci il tuo indirizzo wallet USDT TRC20",
      "ph.wallet_erc": "Inserisci il tuo indirizzo wallet USDT ERC20",
      "ph.wallet_bep": "Inserisci il tuo indirizzo wallet BTC BEP20",
      "ph.wallet_cashapp": "Inserisci il tuo nome utente Cash App",
      "label.delivery_terms": "Termini di consegna:",
      "label.deliverable_content": "Contenuto consegnabile:",
      "label.attach_files": "Allega file:",
      "label.selected_files": "File selezionati:",
      "label.saved_wallets": "Wallet salvati:",
      "note.bank_limit": "NB: I bonifici bancari non sono supportati per importi superiori a $5000.",
      "my.h2": "I Miei Escrow",
      "tbl.id": "ID",
      "tbl.buyer": "Acquirente",
      "tbl.status": "Stato",
      "tbl.amount": "Importo",
      "tbl.wallet": "Portafoglio",
      "tbl.actions": "Azioni",
      "transactions.h2": "Transazioni",
      "kyc.h2": "KYC",
      "kyc.note": "La verifica KYC sar√† richiesta ai venditori che scelgono di ricevere il pagamento tramite bonifico bancario.",
      "footer.guide_title": "üìã Come utilizzare la Dashboard Venditore",
      "footer.step1_title": "Rivedi gli escrow in sospeso:",
      "footer.step1_desc": "Controlla la tabella \"Escrow in sospeso\" per vedere le richieste degli acquirenti. Fai clic su \"Conferma\" per accettare o \"Rifiuta\" per declinare.",
      "footer.step2_title": "Imposta i metodi di prelievo:",
      "footer.step2_desc": "Inserisci i tuoi indirizzi wallet cripto o il tuo nome utente Cash App. Fai clic su \"Salva\" per memorizzare ogni metodo di pagamento.",
      "footer.step3_title": "Invia la consegna:",
      "footer.step3_desc": "Dopo aver confermato un escrow, inserisci l'ID Escrow, descrivi i tuoi consegnabili, allega file se necessario e fai clic su \"Invia consegna\".",
      "footer.step4_title": "Richiedi il rilascio:",
      "footer.step4_desc": "Una volta completata la consegna, inserisci l'ID Escrow e fai clic su \"Richiedi rilascio\" per notificare all'acquirente di rilasciare il pagamento.",
      "footer.step5_title": "Traccia i tuoi escrow:",
      "footer.step5_desc": "Usa la scheda \"I Miei Escrow\" per monitorare tutte le tue transazioni attive.",
      "footer.support_title": "üí¨ Hai bisogno di aiuto?",
      "footer.support_desc": "Il nostro team di supporto √® pronto ad assisterti per qualsiasi domanda o problema.",
      "footer.support_link": "Unisciti al supporto dal vivo su Slack"
    }
  },
es: {
    translation: {
      "title": "Panel de Vendedor ‚Äì VanGuard Escrow",
      "header.title": "Panel de Vendedor",
      "btn.logout": "Cerrar sesi√≥n",
      "nav.escrow": "Configuraci√≥n de Escrow",
      "nav.my_escrows": "Mis Escrows",
      "nav.transactions": "Transacciones",
      "nav.kyc": "KYC",
      "pending.h2": "Escrows pendientes",
      "pending.desc": "Revise las solicitudes de escrow iniciadas por el comprador que esperan su confirmaci√≥n.",
      "delivery.h2": "Enviar entrega y t√©rminos",
      "release.h2": "Solicitar liberaci√≥n de pago",
      "release.desc": "Solicite al comprador que libere el pago despu√©s de completar la entrega. Aseg√∫rese de haber configurado su m√©todo de retiro arriba.",
      "withdrawal.h2": "Configurar su m√©todo de retiro",
      "withdrawal.desc": "Ingrese sus direcciones de billetera donde desea recibir los pagos. Estas se utilizar√°n para todos sus pagos.",
      "method.trc": "USDT TRC20",
      "method.erc": "USDT ERC20",
      "method.bep": "BTC (BEP20)",
      "method.cashapp": "Cash App (solo EE. UU.)",
      "method.bank": "Transferencia bancaria (Revolut Instant)",
      "method.bank_note": "Contacte al soporte para configurar los detalles de transferencia bancaria",
      "btn.copy": "Copiar",
      "btn.save": "Guardar",
      "btn.info": "Info",
      "btn.submit_delivery": "Enviar entrega",
      "btn.request_release": "Solicitar liberaci√≥n",
      "btn.confirm_escrow": "Confirmar escrow",
      "btn.reject_escrow": "Rechazar escrow",
      "ph.escrow_id": "ID de Escrow",
      "ph.delivery_terms": "Describa sus entregables o t√©rminos...",
      "ph.deliverable_content": "Pegue texto entregable, enlaces de descarga o instrucciones...",
      "ph.wallet_trc": "Ingrese su direcci√≥n de billetera USDT TRC20",
      "ph.wallet_erc": "Ingrese su direcci√≥n de billetera USDT ERC20",
      "ph.wallet_bep": "Ingrese su direcci√≥n de billetera BTC BEP20",
      "ph.wallet_cashapp": "Ingrese su nombre de usuario de Cash App",
      "label.delivery_terms": "T√©rminos de entrega:",
      "label.deliverable_content": "Contenido entregable:",
      "label.attach_files": "Adjuntar archivos:",
      "label.selected_files": "Archivos seleccionados:",
      "label.saved_wallets": "Billeteras guardadas:",
      "note.bank_limit": "NB: Las transferencias bancarias no est√°n soportadas para montos superiores a $5000.",
      "my.h2": "Mis Escrows",
      "tbl.id": "ID",
      "tbl.buyer": "Comprador",
      "tbl.status": "Estado",
      "tbl.amount": "Monto",
      "tbl.wallet": "Billetera",
      "tbl.actions": "Acciones",
      "transactions.h2": "Transacciones",
      "kyc.h2": "KYC",
      "kyc.note": "Se requerir√° verificaci√≥n KYC para vendedores que elijan recibir el pago mediante transferencia bancaria.",
      "footer.guide_title": "üìã C√≥mo usar el Panel de Vendedor",
      "footer.step1_title": "Revisar escrows pendientes:",
      "footer.step1_desc": "Consulte la tabla \"Escrows pendientes\" para ver las solicitudes de compradores. Haga clic en \"Confirmar\" para aceptar o \"Rechazar\" para declinar.",
      "footer.step2_title": "Configurar m√©todos de retiro:",
      "footer.step2_desc": "Ingrese sus direcciones de billetera cripto o su nombre de usuario de Cash App. Haga clic en \"Guardar\" para almacenar cada m√©todo de pago.",
      "footer.step3_title": "Enviar entrega:",
      "footer.step3_desc": "Despu√©s de confirmar un escrow, ingrese el ID de Escrow, describa sus entregables, adjunte archivos si es necesario y haga clic en \"Enviar entrega\".",
      "footer.step4_title": "Solicitar liberaci√≥n:",
      "footer.step4_desc": "Una vez completada la entrega, ingrese el ID de Escrow y haga clic en \"Solicitar liberaci√≥n\" para notificar al comprador que libere el pago.",
      "footer.step5_title": "Rastrear sus escrows:",
      "footer.step5_desc": "Use la pesta√±a \"Mis Escrows\" para monitorear todas sus transacciones activas.",
      "footer.support_title": "üí¨ ¬øNecesita ayuda?",
      "footer.support_desc": "Nuestro equipo de soporte est√° listo para ayudarlo con cualquier pregunta o problema.",
      "footer.support_link": "√önase al soporte en vivo en Slack"
    }
  }
};

// Initialize i18next
i18next.init({
  lng: 'en',
  debug: false,
  resources: translations
}, function(err, t) {
  if (err) {
    console.error('i18next initialization error:', err);
    return;
  }
  updateContent();
});

function updateContent() {
  // Update text content
  document.querySelectorAll('[data-i18n]').forEach(element => {
    const key = element.getAttribute('data-i18n');
    const translation = i18next.t(key);
    if (translation && translation !== key) {
      element.textContent = translation;
    }
  });
  
  // Update placeholders
  document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
    const key = element.getAttribute('data-i18n-placeholder');
    const translation = i18next.t(key);
    if (translation && translation !== key) {
      element.placeholder = translation;
    }
  });
  
  // Update page title
  const titleTranslation = i18next.t('title');
  if (titleTranslation && titleTranslation !== 'title') {
    document.title = titleTranslation;
  }
}

// Language switcher event listener
document.getElementById('langSwitcher')?.addEventListener('change', function(e) {
  const selectedLang = e.target.value;
  console.log('Switching language to:', selectedLang);
  i18next.changeLanguage(selectedLang, (err, t) => {
    if (err) {
      console.error('Language change error:', err);
      return;
    }
    console.log('Language changed successfully to:', selectedLang);
    updateContent();
  });
});
</script>
</body>
</html>
